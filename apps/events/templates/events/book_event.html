{% extends 'base.html' %}

{% block title %}Book Tickets for {{ event.title }} - TicketEase{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="fw-bold">Booking for {{ event.title }}</h2>
    <p><strong>Date:</strong> {{ event.date }}</p>
    <p><strong>Location:</strong> {{ event.location }}</p>
    <p><strong>Category:</strong> {{ event.category }}</p>

    <!-- Ticket Selection Section -->
    <h3 class="mt-4">üéüÔ∏è Select Tickets</h3>
    <div id="ticket-selection">
        <!-- Ticket options will be inserted dynamically -->
    </div>

    <!-- Error Message -->
    <p id="error-message" class="text-danger fw-bold" style="display:none;">‚ö†Ô∏è You can select up to 5 tickets only!</p>

    <!-- Total Price -->
    <h4 class="mt-3">Total Price: ‚Çπ<span id="total-price">0.00</span></h4>

    <!-- Proceed Button -->
    <button id="proceed-btn" class="btn btn-primary" disabled>Proceed to Payment</button>
</div>

<!-- JavaScript for Handling Ticket Selection -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const eventId = "{{ event.id }}";  // Get event ID from template
        const ticketContainer = document.getElementById("ticket-selection");
        const totalPriceElement = document.getElementById("total-price");
        const proceedBtn = document.getElementById("proceed-btn");
        const errorMessage = document.getElementById("error-message");

        let totalTickets = 0;
        let ticketPrices = {};  // Store ticket types and prices

        // Fetch ticket types from API
        fetch(`/events/api/events/${eventId}/`)
            .then(response => response.json())
            .then(data => {
                ticketPrices = data.ticket_types;

                for (const [type, price] of Object.entries(ticketPrices)) {
                    const ticketRow = document.createElement("div");
                    ticketRow.classList.add("d-flex", "align-items-center", "mb-3");

                    ticketRow.innerHTML = `
                        <div class="flex-grow-1">
                            <h5 class="mb-0">${type}</h5>
                            <p class="text-muted">‚Çπ${price}</p>
                        </div>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-outline-secondary btn-sm decrease" data-type="${type}">-</button>
                            <span class="mx-2" id="${type}-count">0</span>
                            <button class="btn btn-outline-secondary btn-sm increase" data-type="${type}">+</button>
                        </div>
                    `;

                    ticketContainer.appendChild(ticketRow);
                }

                // Add event listeners for ticket selection
                document.querySelectorAll(".increase").forEach(button => {
                    button.addEventListener("click", function () {
                        updateTicketCount(this.dataset.type, 1);
                    });
                });

                document.querySelectorAll(".decrease").forEach(button => {
                    button.addEventListener("click", function () {
                        updateTicketCount(this.dataset.type, -1);
                    });
                });
            })
            .catch(error => console.error("Error fetching ticket details:", error));

        // Function to update ticket count
        function updateTicketCount(ticketType, change) {
            const countElement = document.getElementById(`${ticketType}-count`);
            let count = parseInt(countElement.innerText) + change;

            if (count < 0) return; // Prevent negative values

            let newTotalTickets = totalTickets + change;

            if (newTotalTickets > 5) {
                errorMessage.style.display = "block";
                return;
            }

            totalTickets = newTotalTickets;
            errorMessage.style.display = "none";
            countElement.innerText = count;

            // Calculate total price
            let totalPrice = 0;
            for (const [type, price] of Object.entries(ticketPrices)) {
                totalPrice += parseInt(document.getElementById(`${type}-count`).innerText) * parseFloat(price);
            }
            totalPriceElement.innerText = totalPrice.toFixed(2);

            // Enable or disable Proceed button
            proceedBtn.disabled = totalTickets === 0;
        }
    });
</script>

{% endblock %}
