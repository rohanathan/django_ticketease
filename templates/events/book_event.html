{% extends 'base.html' %}

{% block title %}Book Tickets for {{ event.title }} - TicketEase{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="fw-bold">Booking for {{ event.title }}</h2>
    <p><strong>Date:</strong> {{ event.date }}</p>
    <p><strong>Location:</strong> {{ event.location }}</p>
    <p><strong>Category:</strong> {{ event.category }}</p>

    <!-- CSRF Token (Added for Django Security) -->
    <input type="hidden" id="csrf_token" value="{{ csrf_token }}">

    <h3 class="mt-4">üéüÔ∏è Select Tickets</h3>
    <div id="ticket-selection"></div>

    <p id="error-message" class="text-danger fw-bold" style="display:none;">‚ö†Ô∏è You can select up to 5 tickets only!</p>
    <h4 class="mt-3">Total Price: ¬£<span id="total-price">0.00</span></h4>

    <button id="proceedToPayment" class="btn btn-primary" disabled>Proceed to Payment</button>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const eventId = "{{ event.id }}";  
        const ticketContainer = document.getElementById("ticket-selection");
        const totalPriceElement = document.getElementById("total-price");
        const proceedBtn = document.getElementById("proceedToPayment");
        const csrfToken = document.getElementById("csrf_token").value; // ‚úÖ Fetch CSRF Token

        let totalTickets = 0;
        let ticketPrices = {};
        let selectedTickets = {};

        // ‚úÖ Fetch ticket types from API
        fetch(`/events/api/events/${eventId}/`)
            .then(response => response.json())
            .then(data => {
                ticketPrices = data.ticket_types;

                for (const [type, price] of Object.entries(ticketPrices)) {
                    const ticketRow = document.createElement("div");
                    ticketRow.classList.add("d-flex", "align-items-center", "mb-3");

                    ticketRow.innerHTML = `
                        <div class="flex-grow-1">
                            <h5 class="mb-0">${type}</h5>
                            <p class="text-muted">¬£${price}</p>
                        </div>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-outline-secondary btn-sm decrease" data-type="${type}">-</button>
                            <span class="mx-2" id="${type}-count">0</span>
                            <button class="btn btn-outline-secondary btn-sm increase" data-type="${type}">+</button>
                        </div>
                    `;

                    ticketContainer.appendChild(ticketRow);
                }

                document.querySelectorAll(".increase").forEach(button => {
                    button.addEventListener("click", function () {
                        updateTicketCount(this.dataset.type, 1);
                    });
                });

                document.querySelectorAll(".decrease").forEach(button => {
                    button.addEventListener("click", function () {
                        updateTicketCount(this.dataset.type, -1);
                    });
                });
            })
            .catch(error => console.error("Error fetching ticket details:", error));

        // ‚úÖ Function to update ticket count
        function updateTicketCount(ticketType, change) {
            const countElement = document.getElementById(`${ticketType}-count`);
            let count = parseInt(countElement.innerText) + change;

            if (count < 0) return;  // Prevent negative values
            if (totalTickets + change > 5) {
                document.getElementById("error-message").style.display = "block";
                return;
            }

            totalTickets += change;
            countElement.innerText = count;
            selectedTickets[ticketType] = count;

            let totalPrice = 0;
            for (const [type, price] of Object.entries(ticketPrices)) {
                totalPrice += parseInt(document.getElementById(`${type}-count`).innerText) * parseFloat(price);
            }
            totalPriceElement.innerText = totalPrice.toFixed(2);

            proceedBtn.disabled = totalTickets === 0;
        }

        // ‚úÖ Handle Proceed to Payment
        proceedBtn.addEventListener("click", function () {
            if (totalTickets === 0) return;

            console.log("‚ö° Sending payment request...");

            fetch(`/events/${eventId}/create-checkout-session/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken,  // ‚úÖ Fixed CSRF Token
                },
                body: JSON.stringify({
                    category: "event",
                    id: eventId,
                    tickets: selectedTickets,
                }),
            })
            .then(response => response.json())
            .then(data => {
                console.log("‚úÖ Stripe Checkout Response:", data);
                if (data.url) {
                    window.location.href = data.url;  // ‚úÖ Redirect to Stripe
                } else {
                    alert("‚ö†Ô∏è Payment error! Please try again.");
                }
            })
            .catch(error => {
                console.error("‚ùå Payment Error:", error);
                alert("‚ö†Ô∏è Payment failed! Check console.");
            });
        });
    });
</script>

{% endblock %}
